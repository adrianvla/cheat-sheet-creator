<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Design Formulaire</title>
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        @page {
            size: A4;
            margin: 0;
        }
        html{
            background:#ccc;
            font-family:system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif
        }
        @media screen {
            body { 
                background: #e0e0e0;
                margin:auto;
                display:flex;
                justify-content:center;
                align-items:center;
                min-height: 100vh;
            }
        
            .page {
                background: white;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                border: 1px solid #000;
                box-sizing: border-box;
                position: relative;
            }
            .sheet-outer{
                display:flex;
                flex-direction: column;
                gap:50px;
                margin-top:50px;
                margin-bottom: 50px;
            }
        }

        .sheet-outer.A4.landscape { 
            width: 297mm;
            height: 210mm;
        }
        .sheet-outer.A4 { 
            width: 210mm;
            height: 297mm;
        }
        @media print {
            .page{
                margin: 0;
                /* border: 1px solid #000; */
            }
            body{
                margin:0;
                background:#fff;
                padding:0;
            }
            html{
                background:#fff;
            }
            .end{
                display:none;
            }
            .no-print {
                display: none !important;
            }
        }
        .page{
            page-break-after: always;
            height:100%;
            margin: 0;
            padding: 0;
        }
        .A4.landscape .page{
            width: 297mm;
            height: 210mm;
        }
    </style>
    <style>
        .grid {  
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr;
            gap: 0px 1px;
            grid-auto-flow: row;
            grid-template-areas:
                ". . .";
            background:#000;
            height:100%;
        }
        .col{
            height:100%;
            background:white;
            display:flex;
            flex-direction: column;
            position: relative;
        }
        .def{
            background-image: linear-gradient(45deg, #ffffff 45%, #ffc144 45.1%, #ffc144 50%, #ffffff 50.1%, #ffffff 95%, #ffc144 95.1%, #ffc144 100%);
            /* color removed to force black text on inside */
            opacity:0.9;
        }
        .thm{
            background-image: linear-gradient(45deg, #ffffff 45%, #ff44f6 45.1%, #ff44f6 50%, #ffffff 50.1%, #ffffff 95%, #ff44f6 95.1%, #ff44f6 100%);
            /* color removed */
            opacity:0.5;
        }
        .ideearg{
            background-image: linear-gradient(45deg, #ffffff 45%, #4a44ff 45.1%, #4a44ff 50%, #ffffff 50.1%, #ffffff 95%, #4a44ff 95.1%, #4a44ff 100%);
            /* color removed */
            opacity:0.5;
        }
        .res{
            background-image: linear-gradient(45deg, #ffffff 45%, #28c900 45.1%, #28c900 50%, #ffffff 50.1%, #ffffff 95%, #28c900 95.1%, #28c900 100%);
            /* color removed */
            opacity:0.6;
        }
        .divider{
            height:1px;
            background:#000;
        }
        .divider{
            position:relative;
            height:0px;
        }
        .divider:before{
            content: "";
            position:absolute;
            top:-1px;
            left:0;
            width:100%;
            height:1px;
            border-top:1px solid #000;
        }
        .sdivider{
            position:relative;
            height:0px;
        }
        .sdivider:before{
            content: "";
            position:absolute;
            top:-1px;
            left:0;
            width:100%;
            height:1px;
            border-top:1px dashed #000;
        }
        .double-divider{
            height:5px;
            box-sizing: border-box;
            border-top:1px solid #000;
            border-bottom:1px solid #000;
        }
        .block{
            background-size: 10px 10px;
            position:relative;
            display:flex;
            /* Alignment defaults handled in JS now */
            overflow: hidden; 
            cursor: pointer;
            transition: outline 0.1s;
        }
        .block:hover {
            outline: 2px solid #007bff;
            z-index: 10;
        }
        .important{
            border:2px dashed #000;
            box-sizing: border-box;
        }
        .inside{
            opacity:0.7;
            display: block;
            width: 100%;
            padding: 2px;
            box-sizing: border-box;
            white-space: normal;
            color: black !important;
            font-weight: 500;
        }
        
        /* UI Controls */
        #editModal {
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 100%;
        }
        #editModal::backdrop {
            background: rgba(0,0,0,0.5);
        }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; box-sizing: border-box; }
        .form-row { display: flex; gap: 10px; }
        .form-row .form-group { flex: 1; }
        
        .modal-actions { display: flex; justify-content: space-between; margin-top: 20px; }
        .btn { padding: 8px 16px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }

        .add-block-btn {
            width: 100%;
            height: 20px;
            background: rgba(0, 123, 255, 0.1);
            border: none;
            cursor: pointer;
            display: none; /* Show on hover of col */
            font-size: 12px;
            color: #007bff;
            text-align: center;
            line-height: 20px;
        }
        .col:hover .add-block-btn {
            display: block;
        }

        .tools {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            gap: 10px;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="sheet-outer A4 landscape" id="content-root">
             <!-- Content will be injected by JS -->
        </div>
    </div>

    <!-- Edit Modal -->
    <dialog id="editModal" class="no-print">
        <form method="dialog" id="editForm">
            <h3 id="modalTitle">Edit Block</h3>
            
            <div class="form-group">
                <label for="blockType">Type</label>
                <select id="blockType" name="type">
                    <option value="def">Definition (Yellow)</option>
                    <option value="thm">Theorem (Pink)</option>
                    <option value="res">Result (Green)</option>
                    <option value="ideearg">Idea/Arg (Blue)</option>
                    <option value="sdivider">Small Divider (dashed)</option>
                    <option value="divider">Divider (Solid)</option>
                    <option value="double-divider">Double Divider</option>
                </select>
            </div>

            <div id="propertyControls">
                <div class="form-group" id="contentGroup">
                    <label for="blockContent">Content (LaTeX allowed)</label>
                    <textarea id="blockContent" name="content" rows="4"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                         <label>
                             <input type="checkbox" id="blockAutoHeight" name="autoHeight"> Auto-fit Height
                         </label>
                    </div>
                    <div class="form-group" id="heightGroup">
                        <label for="blockHeight">Height (e.g. 3.5cm)</label>
                        <input type="text" id="blockHeight" name="height">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="blockFontSize">Font Size %</label>
                        <input type="number" id="blockFontSize" name="fontSize" value="100" min="10" max="300">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="blockVAlign">Vertical Align</label>
                        <select id="blockVAlign">
                            <option value="center">Center</option>
                            <option value="flex-start">Top</option>
                            <option value="flex-end">Bottom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="blockHAlign">Horizontal Align</label>
                        <select id="blockHAlign">
                            <option value="center">Center</option>
                            <option value="flex-start">Left</option>
                            <option value="flex-end">Right</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="importantGroup">
                    <label>
                        <input type="checkbox" id="blockImportant" name="important"> Important (Dashed Border)
                    </label>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-danger" id="deleteBtn">Delete</button>
                <div style="flex-grow:1"></div>
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('editModal').close()">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBtn">Save</button>
            </div>
        </form>
    </dialog>

    <div class="tools no-print">
        <button class="btn btn-secondary" onclick="createNewPage()">+ New Page</button>
        <button class="btn btn-secondary" onclick="exportConfig()">Export .cheat-sheet</button>
        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import .cheat-sheet</button>
        <input type="file" id="importFile" style="display:none" onchange="importConfig(this)">
        <button class="btn btn-danger" onclick="resetConfig()">Reset / New Doc</button>
    </div>

    <script>
        const STORAGE_KEY = 'paperDesignConfig';
        let appState = [];
        let editingRef = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            renderApp();
            
            // Set up handlers
            document.getElementById('saveBtn').addEventListener('click', saveEdit);
            document.getElementById('deleteBtn').addEventListener('click', deleteBlock);
            document.getElementById('blockType').addEventListener('change', updateFormFields);
            document.getElementById('blockAutoHeight').addEventListener('change', updateFormFields);
        });

        function exportConfig() {
            const dataStr = JSON.stringify(appState, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.download = 'design.cheat-sheet';
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function importConfig(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    // Basic validation: should be an array (pages) of arrays (cols)
                    if (Array.isArray(data) && Array.isArray(data[0])) {
                        if(confirm('This will overwrite your current design. Continue?')) {
                            appState = data;
                            saveState();
                            renderApp();
                        }
                    } else {
                        alert('Invalid file format');
                    }
                } catch (err) {
                    alert('Error reading file: ' + err.message);
                }
                // Reset input so same file can be selected again
                input.value = '';
            };
            reader.readAsText(file);
        }

        function resetConfig() {
            if(confirm('This will DELETE all current work and start a new empty document. Are you sure?')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function createEmptyState() {
            // 1 page, 3 empty columns
            return [[ [], [], [] ]];
        }

        function createNewPage() {
            appState.push([ [], [], [] ]);
            saveState();
            renderApp();
            // Scroll to bottom
            window.scrollTo(0, document.body.scrollHeight);
        }

        function updateFormFields() {
            const type = document.getElementById('blockType').value;
            const isDivider = type.includes('divider');
            const isAutoHeight = document.getElementById('blockAutoHeight').checked;

            const controls = document.getElementById('propertyControls');
            controls.style.display = isDivider ? 'none' : 'block';
            
            if (!isDivider) {
                document.getElementById('heightGroup').style.display = isAutoHeight ? 'none' : 'block';
            }
        }

        function loadState() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                appState = JSON.parse(stored);
            } else {
                appState = createEmptyState();
                saveState();
            }
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
        }

        function renderApp() {
            const root = document.getElementById('content-root');
            root.innerHTML = ''; 

            appState.forEach((pageData, pIdx) => {
                const pageEl = document.createElement('section');
                pageEl.className = 'page';
                
                const gridEl = document.createElement('div');
                gridEl.className = 'grid';

                pageData.forEach((colData, cIdx) => {
                    const colEl = document.createElement('div');
                    colEl.className = 'col';

                    colData.forEach((blockData, bIdx) => {
                        const el = createBlockElement(blockData);
                        el.onclick = () => openEditModal(pIdx, cIdx, bIdx);
                        colEl.appendChild(el);
                    });

                    // Add Button
                    const addBtn = document.createElement('button');
                    addBtn.className = 'add-block-btn no-print';
                    addBtn.textContent = '+ Add Block';
                    addBtn.onclick = (e) => {
                        e.stopPropagation();
                        addBlock(pIdx, cIdx);
                    };
                    colEl.appendChild(addBtn);

                    gridEl.appendChild(colEl);
                });

                pageEl.appendChild(gridEl);
                root.appendChild(pageEl);
            });

            // Render Math
            renderMathInElement(root, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError : false
            });

            // Auto Scale
            requestAnimationFrame(autoScaleAll);
        }

        function createBlockElement(data) {
            const div = document.createElement('div');
            
            if (data.type && data.type.includes('divider')) {
                div.className = data.type;
                if (data.type === 'double-divider') {
                    div.className = 'double-divider';
                }
            } else {
                div.className = `block ${data.type}`;
                if (data.important) div.classList.add('important');
                
                // Positioning
                div.style.justifyContent = data.hAlign || 'center';
                div.style.alignItems = data.vAlign || 'center';
                
                // Height defaults
                if (data.autoHeight) {
                    div.style.height = 'auto';
                    div.style.minHeight = '1cm'; // minimum
                    div.style.padding = '5px';
                } else {
                    div.style.height = data.height || '2cm';
                }

                const span = document.createElement('span');
                span.className = 'inside';
                span.innerText = data.content || ''; 
                
                // Apply manual font size if exists
                if (data.manualFontSize && parseInt(data.manualFontSize) !== 100) {
                     span.style.fontSize = data.manualFontSize + '%';
                }

                // Text align for the span itself (multi-line text)
                if (data.hAlign === 'flex-start') span.style.textAlign = 'left';
                else if (data.hAlign === 'flex-end') span.style.textAlign = 'right';
                else span.style.textAlign = 'center';

                div.appendChild(span);
            }
            return div;
        }

        function autoScaleAll() {
            appState.forEach((pageData, pIdx) => {
                pageData.forEach((colData, cIdx) => {
                    colData.forEach((blockData, bIdx) => {
                         // Only auto-scale if NOT auto-height
                         if (!blockData.autoHeight && !blockData.type.includes('divider')) {
                             // Find the actual DOM element
                             // This simple lookup depends on exact render order matches. 
                             // To be safer, we could put IDs, but traversing DOM is OK for this scale.
                             const pages = document.querySelectorAll('.page');
                             const col = pages[pIdx].querySelectorAll('.col')[cIdx];
                             // Account for add-btn being last child
                             const blockEl = col.children[bIdx];
                             if (blockEl && blockEl.classList.contains('block')) {
                                fitText(blockEl.querySelector('.inside'), blockData.manualFontSize || 100);
                             }
                         }
                    });
                });
            });
        }

        function fitText(el, baseSize) {
            const parent = el.parentElement;
            if (!parent) return;
            
            // If manual font size is set, we treat that as the MAXIMUM start point
            let size = parseInt(baseSize) || 100;
            
            el.style.fontSize = size + '%'; // Start reset
            
            // Reduce only
            while ( (el.scrollHeight > parent.clientHeight || el.scrollWidth > parent.clientWidth) && size > 10) {
                 size -= 5;
                 el.style.fontSize = size + '%';
            }
            // Fine tune 1%
            while ( (el.scrollHeight > parent.clientHeight || el.scrollWidth > parent.clientWidth) && size > 5) {
                 size -= 1;
                 el.style.fontSize = size + '%';
            }
        }

        function openEditModal(pIdx, cIdx, bIdx) {
            editingRef = { pIdx, cIdx, bIdx };
            const block = appState[pIdx][cIdx][bIdx];
            
            document.getElementById('blockType').value = block.type || 'def';
            document.getElementById('blockContent').value = block.content || '';
            
            // Height
            document.getElementById('blockAutoHeight').checked = !!block.autoHeight;
            document.getElementById('blockHeight').value = block.height || '2cm';

            // Font
            document.getElementById('blockFontSize').value = block.manualFontSize || 100;

            // Align
            document.getElementById('blockVAlign').value = block.vAlign || 'center';
            document.getElementById('blockHAlign').value = block.hAlign || 'center';

            document.getElementById('blockImportant').checked = !!block.important;
            
            updateFormFields();
            document.getElementById('editModal').showModal();
        }

        function saveEdit() {
            if (!editingRef) return;
            const { pIdx, cIdx, bIdx } = editingRef;
            
            const type = document.getElementById('blockType').value;
            const content = document.getElementById('blockContent').value;
            const isAutoHeight = document.getElementById('blockAutoHeight').checked;
            const height = document.getElementById('blockHeight').value;
            const fontSize = document.getElementById('blockFontSize').value;
            const vAlign = document.getElementById('blockVAlign').value;
            const hAlign = document.getElementById('blockHAlign').value;
            const important = document.getElementById('blockImportant').checked;

            appState[pIdx][cIdx][bIdx] = {
                type,
                content: type.includes('divider') ? '' : content,
                height: height,
                autoHeight: isAutoHeight,
                manualFontSize: fontSize,
                vAlign,
                hAlign,
                important: type.includes('divider') ? false : important
            };

            saveState();
            renderApp();
            document.getElementById('editModal').close();
            editingRef = null;
        }

        function deleteBlock() {
            if (!editingRef) return;
            const { pIdx, cIdx, bIdx } = editingRef;
            
            if(confirm('Delete this block?')) {
                appState[pIdx][cIdx].splice(bIdx, 1);
                saveState();
                renderApp();
                document.getElementById('editModal').close();
                editingRef = null;
            }
        }

        function addBlock(pIdx, cIdx) {
            const col = appState[pIdx][cIdx];
            if (col.length > 0) {
                 col.push({ type: 'sdivider' });
            }
            col.push({ 
                type: 'def', 
                height: '2cm', 
                content: 'New Block', 
                important: false,
                autoHeight: false,
                manualFontSize: 100,
                vAlign: 'center',
                hAlign: 'center'
            });
            saveState();
            renderApp();
            
            // Automatically open edit for the new block
            openEditModal(pIdx, cIdx, col.length - 1);
        }

    </script>
</body>
</html>
